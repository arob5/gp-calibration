---
title: "EKI_tests"
author: "Andrew Roberts"
date: '2023-11-28'
output: html_document
---

```{r, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(lhs)
library(hetGP)
library(mlegp)
library(ggplot2)
library(viridis)
library(parallel)
library(gridExtra)
library(data.table)
library(BayesianTools)

base_dir <- "." # Should be EKI dir
helper_func_dir <- file.path(base_dir, "..", "vsem_calibration_tests")

source(file.path(helper_func_dir, "numerical_experiment_functions.r"))
source(file.path(helper_func_dir, "mcmc_calibration_functions.r"))
source(file.path(helper_func_dir, "gp_emulator_functions.r"))
source(file.path(helper_func_dir, "gp_mcmc_functions.r"))
source(file.path(helper_func_dir, "sequential_design_optimization.r"))
```

# Linear Gaussian Model

```{r}
# Linear Gaussian Model Setup. 
data_seed <- 23
d <- 2
N_obs <- 100
freqs <- c(1, 2) 
G <- cbind(sin(2*pi*freqs[1]*seq(1, N_obs)/N_obs), sin(2*pi*freqs[2]*seq(1, N_obs)/N_obs))

sig2_eps <- 1
Sig0 <- diag(c(1, 4))
m0 <- matrix(rep(0, d), ncol=1)
```

```{r}
linear_Gaussian_info <- generate_linear_Gaussian_test_data(data_seed, N_obs=N_obs, 
                                                           D=d, Sig_theta=Sig0, 
                                                           G=G, sig2_eps=sig2_eps)
computer_model_data <- linear_Gaussian_info$computer_model_data
theta_prior_params <- linear_Gaussian_info$theta_prior_params
linear_Gaussian_info$true_posterior$SSR <- get_computer_model_SSR(computer_model_data, 
                                                                  theta_vals=linear_Gaussian_info$true_posterior$mean, 
                                                                  na.rm=TRUE)

```

```{r}
# Plot linear Gaussian data. 

sim_data <- as.data.frame(computer_model_data$data_obs)
sim_data$ref <- computer_model_data$data_ref
sim_data$time <- 1:N_obs
linear_Gaussian_data_plt <- ggplot(sim_data) + geom_point(mapping=aes(x=time, y=y)) + 
                              geom_line(mapping=aes(x=time, y=ref), color="red") + 
                              xlab("t") + ylab("output") + ggtitle("Ground Truth and Observed Data")

plot(linear_Gaussian_data_plt)
```

```{r}
# Multiscale algorithm test. 

time_step <- .001
sigma <- 0.01
delta <- .0001
N_ensemble <- 90
N_itr <- 5000

u_samp <- run_multiscale_inversion(computer_model_data, m0, Sig0, N_itr, time_step,
                                   sigma, delta, N_ensemble)
```

```{r}
plot(u_samp[1000:5000,1], u_samp[1000:5000,2])
```

```{r}
# Exact samples
N_samp_exact <- 25000
m_true <- linear_Gaussian_info$true_posterior$mean
C_true <- linear_Gaussian_info$true_posterior$Cov
L_C_true <- t(chol(C_true))
samp_exact <- t(drop(m_true) + L_C_true %*% matrix(rnorm(N_samp_exact*d), nrow=d, ncol=N_samp_exact))

plot(samp_exact[,1], samp_exact[,2])
```






