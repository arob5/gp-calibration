#
# define_Bayesian_inverse_problem.r
#
# This script is required for the experiment type `llik_emulator_seq_design` (lesd). 
# In particular, it creates objects which define the forward model, likelihood, 
# and priors, which together characterize the Bayesian inverse problem which 
# is fixed for the duration of the experiment. 
#
# The `config` object is assumed to already be saved in the global environment.  
#

# Source scripts. 
src_dir <- file.path(base_dir, "src")
source(file.path(src_dir, "mcmc_calibration_functions.r"))
source(file.path(src_dir, "statistical_helper_functions.r"))
source(file.path(src_dir, "general_helper_functions.r"))
source(file.path(src_dir, "gpWrapper.r"))
source(file.path(src_dir, "llikEmulator.r"))


define_Bayesian_inverse_problem <- function(config) {

  # -----------------------------------------------------------------------------
  # Set data seed. 
  # -----------------------------------------------------------------------------
  
  set.seed(config$experiment_type_settings$data_seed)
  
  # -----------------------------------------------------------------------------
  # Define forward model. 
  # -----------------------------------------------------------------------------
  
  # Linear model defined as a linear combination of sine curves of various frequencies. 
  # Sample frequencies from log-normal distribution. 
  N_freqs <- 10L
  freqs <- rlnorm(10, meanlog=0, sdlog=1)
  
  # Number of time steps determine the dimension of the output space. 
  N_time <- 100
  G <- matrix(nrow=N_time, ncol=N_freqs)
  for(d in 1:N_freqs) G[,d] <- matrix(sin(2*pi*freqs[d]*seq(1, N_time)/N_time), ncol=1)
  
  # Forward model, vectorized and non-vectorized versions. 
  fwd_model <- function(input) {G %*% matrix(input, ncol=1)}
  fwd_model_vectorized <- function(input) {G %*% t(input)}
  
  # -----------------------------------------------------------------------------
  # True calibration parameter and true latent signal (i.e. true output)
  # -----------------------------------------------------------------------------
  
  # Sampling the true parameter value from a Gaussian distribution, with 
  # mean vector itself sampled from another Gaussian distribution, and 
  # covariance matrix generated by an Gaussian kernel defined 
  # on the frequencies. 
  par_dist_mean <- rnorm(N_freqs, mean=0, sd=3)
  par_dist_cov <- hetGP::cov_gen(matrix(freqs, ncol=1), theta=1, type="Gaussian")
  par_true <- par_dist_mean + drop(t(chol(par_dist_cov)) %*% matrix(rnorm(N_freqs), ncol=1))
  
  # True latent signal. 
  output_true <- fwd_model(par_true)
  
  # -----------------------------------------------------------------------------
  # True variance parameters.
  # -----------------------------------------------------------------------------
  
  # Assuming homoskedastic variance, so single variance parameter to define. 
  # Set it by defining the standard deviatipon to be a fixed proportion of the 
  # true output mean. 
  
  frac_mean <- 0.8
  sig2_true <- (frac_mean * mean(output_true))^2
  ground_truth <- list(par_true=par_true, lik_par_true=sig2_true)
  
  # -----------------------------------------------------------------------------
  # Calibration parameter priors and variance parameter priors. 
  # -----------------------------------------------------------------------------
  
  # Independent standard Gaussian priors on each calibration parameter. 
  par_prior_params <- data.frame(dist = rep("Gaussian", N_freqs), 
                                 param1 = rep(0, N_freqs), 
                                 param2 = rep(1, N_freqs))
  
  # Inverse Gamma prior on the variance.  
  sig2_prior_info <- get_IG_priors_numerical_test(sig2_true=sig2_true, 
                                                  bias_frac = 0.4, bins=50,
                                                  coef_var=0.8, return_prior_plots=TRUE)
  sig2_prior_params <- sig2_prior_info$prior
  
  
  # -----------------------------------------------------------------------------
  # Simulate data. 
  # -----------------------------------------------------------------------------
  
  # Simulate data. 
  y <- output_true + rnorm(N_time, 0, sqrt(sig2_true))
    
  # Add missing observations. 
  N_missing <- 10
  y[sample.int(N_time, N_missing)] <- NA_real_
  
  # Plot data.
  df_plot <- data.frame(x=1:N_time, y_obs=y, y_true=output_true)
  plt <- ggplot(data=df_plot) + 
          geom_line(aes(x=x, y=output_true), color="red") +
          geom_point(aes(x=x, y=y_obs), color="black") + 
          ggtitle("Ground truth and observed data.") + 
          xlab("time step") + ylab("output")
  plt_path <- file.path(config$base_paths["output_dir"], "ground_truth_and_observed_data.png")
  ggsave(plt_path, plot=plt)
  
  
  # -----------------------------------------------------------------------------
  # Instantiate exact llikEmulator object. 
  # -----------------------------------------------------------------------------
  
  llik_exact <- llikEmulatorExactGaussDiag(llik_lbl="exact", fwd_model=fwd_model, 
                                           fwd_model_vectorized=fwd_model_vectorized, 
                                           y_obs=y, dim_par=N_freqs, use_fixed_lik_par=FALSE)
  rownames(par_prior_params) <- llik_exact$input_names                                       

  return(list(llik_exact=llik_exact, par_prior_params=par_prior_params, 
              lik_par_prior_params=sig2_prior_params, ground_truth=ground_truth))
  
}


 

