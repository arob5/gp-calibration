---
title: "One-Dimensional Input Example for Basic Visualization"
author: "Andrew Roberts"
date: '2024-05-12'
output: html_document
---

```{r, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(lhs)
library(kde1d)
library(ggplot2)
library(viridis)
library(parallel)
library(gridExtra)
library(data.table)

base_dir <- getwd()
src_dir <- file.path(base_dir, "src")
output_dir <- file.path(base_dir, "output", "gp_post_approx_paper", "test_1d_visualization")

source(file.path(src_dir, "gpWrapper.r"))
source(file.path(src_dir, "general_helper_functions.r"))
source(file.path(src_dir, "statistical_helper_functions.r"))
source(file.path(src_dir, "plotting_helper_functions.r"))
source(file.path(src_dir, "llikEmulator.r"))
source(file.path(src_dir, "gp_emulator_functions.r"))
source(file.path(src_dir, "sim_study_functions.r"))
source(file.path(src_dir, "mcmc_calibration_functions.r"))
source(file.path(src_dir, "seq_design_gp.r"))
source(file.path(src_dir, "seq_design.r"))
source(file.path(src_dir, "gp_mcmc_functions.r"))

# Plot settings applied to all plots. 
design_pt_size <- 4
line_thickness <- 1.5
design_color <- "red"
xlim <- c(-10, 10)
ylim <- c(0.0777, 0.4)

# Settings for noisy MCMC. 
N_mcmc <- 50000
burn_in_start <- N_mcmc/2

# Basic trapezoidal rule for numerical integration, for approximating normalizing constants. 
int_trap <- function(x, dx) {
  x <- drop(x)
  n_pts <- length(x)

  return(0.5 * dx * (x[1] + x[n_pts]) +  dx * sum(x[2:(n_pts-1)]))
}

```


```{r}
#
# Define inverse problem: 
#    nonlinear forward model, Gaussian likelihood with known variance, 
#    uniform prior, so focus on the likelihood as the prior does not affect things. 
#

seed_inv_prob <- 35
set.seed(seed_inv_prob)

# Forward model. 
N_obs <- 1
fwd_model <- function(u) sin(u) + 0.1*u

# Priors and true parameter values. 
par_prior_params <- data.frame(dist="Uniform", param1=xlim[1], param2=xlim[2])
rownames(par_prior_params) <- "u"
u_true <- 3.0
sig2_true <- 1
y <- 0 # fwd_model(rep(u_true, N_obs)) + sqrt(sig2_true) * rnorm(N_obs)

# Exact likelihood. 
default_conditional <- FALSE
default_normalize <- TRUE
llik_exact <- llikEmulatorExactGaussDiag(llik_lbl="exact", fwd_model=fwd_model, 
                                         y_obs=y, dim_par=1L, use_fixed_lik_par=TRUE,
                                         sig2=sig2_true, par_names=rownames(par_prior_params), 
                                         default_conditional=default_conditional, 
                                         default_normalize=default_normalize)
inv_prob <- list(llik=llik_exact, par_prior=par_prior_params, y=y, par_true=u_true, sig2_true=sig2_true)

# Create grid for plotting. 
N_grid <- 201
u_grid <- get_tensor_product_grid(N_grid, inv_prob$par_prior)
test_info <- list(input=u_grid)
test_info$fwd <- llik_exact$run_fwd_model(test_info$input)[1,] # TODO: don't need this indexing once I update the llikEmulator class. 
test_info$llik <- llik_exact$assemble_llik(test_info$input)
test_info$lprior <- calc_lprior_theta(test_info$input, inv_prob$par_prior)

# Plot true unnormalized posterior density. 
plot(test_info$input, test_info$fwd, type="l", 
     main="True forward model evaluations", xlab="u", ylab="G(u)")
plot(test_info$input, test_info$llik, type="l", 
     main="True log-likelihood", xlab="u", ylab="density")
plot(test_info$input, exp(test_info$llik), type="l", 
     main="True likelihood", xlab="u", ylab="density")

```

```{r}
# 
# Initial design and fit emulators. 
#

seed_init_design <- 23
set.seed(seed_init_design)

# Generate design. 
N_design <- 7
design_info <- list()
design_info$input <- get_batch_design("LHS", N_design, prior_params=inv_prob$par_prior)
design_info$fwd <- llik_exact$run_fwd_model(design_info$input)[1,]
design_info$llik <- llik_exact$assemble_llik(design_info$input)
design_info$lprior <- calc_lprior_theta(design_info$input, inv_prob$par_prior)

# Log-likelihood emulator. 
em_llik_gp <- gpWrapperHet(design_info$input, matrix(design_info$llik, ncol=1), normalize_output=TRUE, scale_input=TRUE)
em_llik_gp$fit("Gaussian", "constant", estimate_nugget=FALSE)
em_llik <- llikEmulatorGP("em_llik", em_llik_gp, default_conditional=default_conditional, 
                          default_normalize=default_normalize, lik_par=inv_prob$sig2_true, 
                          use_fixed_lik_par=TRUE)
emulator_pred_llik <- em_llik$predict_emulator(test_info$input, return_cov=TRUE)

# Forward model emulator.
em_fwd_gp <- gpWrapperHet(design_info$input, matrix(design_info$fwd, ncol=1), normalize_output=TRUE, scale_input=TRUE)
em_fwd_gp$fit("Gaussian", "constant", estimate_nugget=FALSE)
em_fwd <- llikEmulatorFwdGaussDiag("em_fwd", em_fwd_gp, matrix(y), sig2=inv_prob$sig2_true, 
                                   default_conditional=default_conditional, 
                                   default_normalize=default_normalize, use_fixed_lik_par=TRUE, 
                                   par_names=rownames(par_prior_params))
emulator_pred_fwd <- em_fwd$predict_emulator(test_info$input, return_cov=TRUE)
```


```{r}
#
# Emulator Distribution plots.  
#

# Probability for confidence intervals to use in plots. 
CI_prob <- pnorm(1) - pnorm(-1) # i.e., plot +/- 1 std dev 
N_std_dev <- 1

# (1): Plot the underlying GP emulator predictive distributions.  
plt_gp_dist_llik <- em_llik$emulator_model$plot_pred_1d(test_info$input, include_interval=TRUE,
                                                        interval_method="pm_std_dev", N_std_dev=N_std_dev,
                                                        pred_list=emulator_pred_llik, ylab="L(u)",
                                                        Y_new=matrix(test_info$llik, ncol=1), line_thickness=line_thickness,
                                                        design_color=design_color, design_pt_size=design_pt_size, 
                                                        plot_title="GP predictions [llik]")[[1]]
plt_gp_dist_fwd <- em_fwd$emulator_model$plot_pred_1d(test_info$input, include_interval=TRUE,
                                                      interval_method="pm_std_dev", N_std_dev=N_std_dev,
                                                      pred_list=emulator_pred_fwd, ylab="G(u)",
                                                      Y_new=matrix(test_info$fwd, ncol=1), line_thickness=line_thickness,
                                                      design_color=design_color, design_pt_size=design_pt_size, 
                                                      plot_title="GP predictions [fwd]")[[1]]

# (2): Plot the log-likelihood emulator predictive distributions. 
plt_llik_dist_llik <- em_llik$plot_pred_1d(test_info$input, emulator_pred_list=emulator_pred_llik,
                                           plot_type="llik", include_interval=TRUE,
                                           interval_method="pm_std_dev", N_std_dev=N_std_dev,
                                           true_llik=test_info$llik, CI_prob=CI_prob, line_thickness=line_thickness,
                                           design_color=design_color, design_pt_size=design_pt_size,
                                           plot_title="log-likelihood predictions [llik]", ylab="L(u)")
plt_llik_dist_fwd <- em_fwd$plot_pred_1d(test_info$input, emulator_pred_list=emulator_pred_fwd,
                                         plot_type="llik", include_interval=TRUE,  
                                         interval_method="pm_std_dev", N_std_dev=N_std_dev,
                                         true_llik=test_info$llik, CI_prob=CI_prob, ylab="L(u)",
                                         design_color=design_color, design_pt_size=design_pt_size,
                                         plot_title="log-likelihood predictions [fwd]")

# (3): Plot the likelihood emulator predictive distributions. 
plt_lik_dist_llik <- em_llik$plot_pred_1d(test_info$input, emulator_pred_list=emulator_pred_llik,
                                          plot_type="lik", include_interval=TRUE, 
                                          interval_method="pm_std_dev", N_std_dev=N_std_dev,
                                          true_llik=test_info$llik, CI_prob=CI_prob, line_thickness=line_thickness,
                                          design_color=design_color, design_pt_size=design_pt_size, ylab="exp L(u)",
                                          plot_title="likelihood predictions [llik]")

# TODO: why doesnt this throw an error when using "CI"?
plt_lik_dist_fwd <- em_fwd$plot_pred_1d(test_info$input, emulator_pred_list=emulator_pred_fwd, 
                                        plot_type="lik", include_interval=TRUE, 
                                        interval_method="pm_std_dev", N_std_dev=N_std_dev,
                                        true_llik=test_info$llik, CI_prob=CI_prob, line_thickness=line_thickness,
                                        design_color=design_color, design_pt_size=design_pt_size, ylab="exp L(u)",
                                        plot_title="likelihood predictions [fwd]")

#
# Plot formatting and saving. 
# 

# Align axes: log-likelihood. 
lims_llik <- get_common_lims(plt_gp_dist_llik, plt_llik_dist_llik, plt_llik_dist_fwd)

# Align axes: likelihood. 
lims_lik <- get_common_lims(plt_lik_dist_llik, plt_lik_dist_fwd)

# GP Emulator plots. 
plt_gp_dist_llik <- ggformat_journal(plt_gp_dist_llik, xlim=lims_llik$xlim, ylim=lims_llik$ylim)
plt_gp_dist_fwd <- ggformat_journal(plt_gp_dist_fwd, xlim=lims_llik$xlim)
plot(plt_gp_dist_llik)
plot(plt_gp_dist_fwd)
ggsave(file.path(output_dir, "gp_dist_llikem.png"), plt_gp_dist_llik)
ggsave(file.path(output_dir, "gp_dist_fwdem.png"), plt_gp_dist_fwd)

# Log-likelihood plots. 
plt_llik_dist_llik <- ggformat_journal(plt_llik_dist_llik, xlim=lims_llik$xlim, ylim=lims_llik$ylim)
plt_llik_dist_fwd <- ggformat_journal(plt_llik_dist_fwd, xlim=lims_llik$xlim, ylim=lims_llik$ylim)
plot(plt_llik_dist_llik)
plot(plt_llik_dist_fwd)
ggsave(file.path(output_dir, "llik_dist_llikem.png"), plt_llik_dist_llik)
ggsave(file.path(output_dir, "llik_dist_fwdem.png"), plt_llik_dist_fwd)

# Likelihood plots. 
plt_lik_dist_llik <- ggformat_journal(plt_lik_dist_llik, xlim=lims_lik$xlim, ylim=lims_lik$ylim)
plt_lik_dist_fwd <- ggformat_journal(plt_lik_dist_fwd, xlim=lims_lik$xlim, ylim=lims_lik$ylim)
plot(plt_lik_dist_llik)
plot(plt_lik_dist_fwd)
ggsave(file.path(output_dir, "lik_dist_llikem.png"), plt_lik_dist_llik)
ggsave(file.path(output_dir, "lik_dist_fwdem.png"), plt_lik_dist_fwd)

```
```{r}
#
# Compute (approximately) normalized exact posterior. 
#

dx <- abs(test_info$input[2] - test_info$input[1])
norm_cst_exact <- int_trap(exp(test_info$llik + test_info$lprior), dx)
test_info$post <- exp(test_info$llik + test_info$lprior) / norm_cst_exact
design_info$post <- exp(design_info$llik + design_info$lprior) / norm_cst_exact

```



```{r}
#
# Comparison of different posterior approximations. 
#

# Convenience function for normalization. 
normalize_lik <- function(lik, dx) {
  lik * exp(test_info$lprior)  / int_trap(lik * exp(test_info$lprior), dx)
}

# Log-likelihood emulation. 
lik_approx_llik <- em_llik$calc_lik_approx_comparison(test_info$input, approx_types=c("mean", "marginal"), 
                                                      emulator_pred_list=emulator_pred_llik)
lik_approx_llik <- apply(lik_approx_llik, 2, function(x) normalize_lik(x, dx))
lik_approx_llik_plt <- plot_curves_1d_helper(test_info$input, lik_approx_llik, y_new=test_info$post,
                                             X_design=design_info$input, y_design=design_info$post,
                                             plot_title="Posterior Approximations [llik]",
                                             line_thickness=line_thickness, design_color=design_color,
                                             design_pt_size=design_pt_size, xlab="u",  ylab="pi(u)") %>%
                                             ggformat_journal(legend_position="none")
plot(lik_approx_llik_plt)

# Forward model emulation. 
lik_approx_fwd <- em_fwd$calc_lik_approx_comparison(test_info$input, approx_types=c("mean", "marginal"), 
                                                    emulator_pred_list=emulator_pred_fwd)
lik_approx_fwd <- apply(lik_approx_fwd, 2, function(x) normalize_lik(x, dx))
lik_approx_fwd_plt <- plot_curves_1d_helper(test_info$input, lik_approx_fwd, y_new=test_info$post,
                                            X_design=design_info$input, y_design=design_info$post,
                                            plot_title="Likelihood Approximations [fwd]",
                                            line_thickness=line_thickness, design_color=design_color,
                                            design_pt_size=design_pt_size, xlab="u", 
                                            ylab="exp L(u)") %>% ggformat_journal(legend_position="none")
plot(lik_approx_fwd_plt)
```
```{r}
# MCWMH approaches. 

# Initial condition for all MCMC algorithms. 
mcmc_par_init <- sample_prior_theta(inv_prob$par_prior)

#
# Log-likelihood emulator. 
#

# MCWMH-Ind. 
mcmh_nocov_llik_list <- mcmc_gp_noisy(em_llik, inv_prob$par_prior, N_itr=N_mcmc, mode="MCMH", 
                                      use_gp_cov=FALSE, par_init=mcmc_par_init)
samp_dt <- format_mcmc_output(mcmh_nocov_llik_list, test_label="nocov-llik")

# MCWMH-Joint. 
mcmh_cov_llik_list <- mcmc_gp_noisy(em_llik, inv_prob$par_prior, N_itr=N_mcmc, mode="MCMH", 
                                    use_gp_cov=TRUE, par_init=mcmc_par_init)
samp_dt <- append_mcmc_output(samp_dt, mcmh_cov_llik_list, test_label="cov-llik")

#
# Forward model emulator. 
#

# MCWMH-Ind. 
mcmh_nocov_fwd_list <- mcmc_gp_noisy(em_fwd, inv_prob$par_prior, N_itr=N_mcmc, mode="MCMH", 
                                     use_gp_cov=FALSE, par_init=mcmc_par_init)
samp_dt <- append_mcmc_output(samp_dt, mcmh_nocov_fwd_list, test_label="nocov-fwd")

# MCWMH-Joint. 
mcmh_cov_fwd_list <- mcmc_gp_noisy(em_fwd, inv_prob$par_prior, N_itr=N_mcmc, mode="MCMH", 
                                   use_gp_cov=TRUE, par_init=mcmc_par_init)
samp_dt <- append_mcmc_output(samp_dt, mcmh_cov_fwd_list, test_label="cov-fwd")

```


```{r}
# MCMC diagnostics.

trace_plots <- get_trace_plots(samp_dt, burn_in_start=burn_in_start) 
for(plt in trace_plots) plot(plt) 

get_hist_plot_comparisons(samp_dt, burn_in_start=burn_in_start, test_label_baseline="nocov-llik")
```

```{r}

#
# Produce kernel density approximations of posterior using MCMC samples. 
# 

#
# Log-likelihood emulator. 
#

# MCWMH-Ind. 
kde_fit_mcwmh_ind_llik <- kde1d(select_mcmc_samp(samp_dt, burn_in_start=burn_in_start, test_labels="nocov-llik")$sample)
lik_approx_llik <- cbind(lik_approx_llik, `mcwmh-ind`=dkde1d(test_info$input, kde_fit_mcwmh_ind_llik))

# MCWMH-Joint. 
kde_fit_mcwmh_joint_llik <- kde1d(select_mcmc_samp(samp_dt, burn_in_start=burn_in_start, test_labels="cov-llik")$sample)
lik_approx_llik <- cbind(lik_approx_llik, `mcwmh-joint`=dkde1d(test_info$input, kde_fit_mcwmh_joint_llik))

#
# Forward model emulator. 
#

# MCWMH-Ind. 
kde_fit_mcwmh_ind_fwd <- kde1d(select_mcmc_samp(samp_dt, burn_in_start=burn_in_start, test_labels="nocov-fwd")$sample)
lik_approx_fwd <- cbind(lik_approx_fwd, `mcwmh-ind`=dkde1d(test_info$input, kde_fit_mcwmh_ind_fwd))

# MCWMH-Joint. 
kde_fit_mcwmh_joint_fwd <- kde1d(select_mcmc_samp(samp_dt, burn_in_start=burn_in_start, test_labels="cov-fwd")$sample)
lik_approx_fwd <- cbind(lik_approx_fwd, `mcwmh-joint`=dkde1d(test_info$input, kde_fit_mcwmh_joint_fwd))


```


```{r}
#
# Plot: comparison of posterior approximations. 
#

# Log-likelihood emulator. 
post_approx_llik_plt <- plot_curves_1d_helper(test_info$input, lik_approx_llik, y_new=test_info$post,
                                              X_design=design_info$input, y_design=design_info$post,
                                              plot_title="Posterior Approximations [llik]",
                                              line_thickness=line_thickness, design_color=design_color,
                                              design_pt_size=design_pt_size, xlab="u",  ylab="pi(u)") %>%
                                              ggformat_journal(legend_position="bottom", 
                                                               legend.text=element_text(size=20))

# Forward model emulator. 
post_approx_fwd_plt <- plot_curves_1d_helper(test_info$input, lik_approx_fwd, y_new=test_info$post,
                                             X_design=design_info$input, y_design=design_info$post,
                                             plot_title="Posterior Approximations [llik]",
                                             line_thickness=line_thickness, design_color=design_color,
                                             design_pt_size=design_pt_size, xlab="u",  ylab="pi(u)") %>%
                                             ggformat_journal(legend_position="bottom", 
                                                               legend.text=element_text(size=20))

plot(post_approx_llik_plt)
plot(post_approx_fwd_plt)
ggsave(file.path(output_dir, "post_approx_llikem.png"), post_approx_llik_plt)
ggsave(file.path(output_dir, "post_approx_fwdem.png"), post_approx_fwd_plt)

```











