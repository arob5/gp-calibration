---
title: "One-Dimensional Input Example for Basic Visualization"
author: "Andrew Roberts"
date: '2024-05-12'
output: html_document
---

```{r, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(lhs)
library(ggplot2)
library(viridis)
library(parallel)
library(gridExtra)
library(data.table)

base_dir <- getwd()
src_dir <- file.path(base_dir, "src")
output_dir <- file.path(base_dir, "output", "gp_post_approx_paper", "test_1d_visualization")

source(file.path(src_dir, "gpWrapper.r"))
source(file.path(src_dir, "general_helper_functions.r"))
source(file.path(src_dir, "statistical_helper_functions.r"))
source(file.path(src_dir, "plotting_helper_functions.r"))
source(file.path(src_dir, "llikEmulator.r"))
source(file.path(src_dir, "gp_emulator_functions.r"))
source(file.path(src_dir, "sim_study_functions.r"))
source(file.path(src_dir, "mcmc_calibration_functions.r"))
source(file.path(src_dir, "seq_design_gp.r"))
source(file.path(src_dir, "seq_design.r"))
source(file.path(src_dir, "gp_mcmc_functions.r"))
```


```{r}
#
# Define inverse problem: 
#    nonlinear forward model, Gaussian likelihood with known variance, 
#    uniform prior, so focus on the likelihood as the prior does not affect things. 
#

seed_inv_prob <- 35
set.seed(seed_inv_prob)

# Forward model. 
N_obs <- 1
fwd_model <- function(u) sin(u) + 0.1*u

# Priors and true parameter values. 
par_prior_params <- data.frame(dist="Uniform", param1=-10, param2=10)
rownames(par_prior_params) <- "u"
u_true <- 3.0
sig2_true <- 1
y <- 0 # fwd_model(rep(u_true, N_obs)) + sqrt(sig2_true) * rnorm(N_obs)

# Exact likelihood. 
default_conditional <- FALSE
default_normalize <- TRUE
llik_exact <- llikEmulatorExactGaussDiag(llik_lbl="exact", fwd_model=fwd_model, 
                                         y_obs=y, dim_par=1L, use_fixed_lik_par=TRUE,
                                         sig2=sig2_true, par_names=rownames(par_prior_params), 
                                         default_conditional=default_conditional, 
                                         default_normalize=default_normalize)
inv_prob <- list(llik=llik_exact, par_prior=par_prior_params, y=y, par_true=u_true, sig2_true=sig2_true)

# Create grid for plotting. 
N_grid <- 201
u_grid <- get_tensor_product_grid(N_grid, inv_prob$par_prior)
test_info <- list(input=u_grid)
test_info$fwd <- llik_exact$run_fwd_model(test_info$input)[1,] # TODO: don't need this indexing once I update the llikEmulator class. 
test_info$llik <- llik_exact$assemble_llik(test_info$input)
test_info$lprior <- calc_lprior_theta(test_info$input, inv_prob$par_prior)
test_info$lpost <- test_info$llik + test_info$lprior

# Plot true unnormalized posterior density. 
plot(test_info$input, test_info$fwd, type="l", 
     main="True forward model evaluations", xlab="u", ylab="G(u)")
plot(test_info$input, test_info$llik, type="l", 
     main="True log-likelihood", xlab="u", ylab="density")
plot(test_info$input, exp(test_info$llik), type="l", 
     main="True likelihood", xlab="u", ylab="density")

```

```{r}
# 
# Initial design and fit emulators. 
#

seed_init_design <- 23
set.seed(seed_init_design)

# Probability for confidence intervals to use in plots. 
CI_prob <- pnorm(1) - pnorm(-1) # i.e., plot +/- 1 std dev 

# Generate design. 
N_design <- 7
design_info <- list()
design_info$input <- get_batch_design("LHS", N_design, prior_params=inv_prob$par_prior)
design_info$fwd <- llik_exact$run_fwd_model(design_info$input)[1,]
design_info$llik <- llik_exact$assemble_llik(design_info$input)
design_info$lprior <- calc_lprior_theta(design_info$input, inv_prob$par_prior)
design_info$lpost <- design_info$llik + design_info$lprior

# Log-likelihood emulator. 
em_llik_gp <- gpWrapperHet(design_info$input, matrix(design_info$llik, ncol=1), normalize_output=TRUE, scale_input=TRUE)
em_llik_gp$fit("Gaussian", "constant", estimate_nugget=FALSE)
em_llik <- llikEmulatorGP("em_llik", em_llik_gp, default_conditional=default_conditional, 
                          default_normalize=default_normalize, lik_par=inv_prob$sig2_true, 
                          use_fixed_lik_par=TRUE)
emulator_pred_llik <- em_llik$predict_emulator(test_info$input, return_cov=TRUE)

# Forward model emulator.
em_fwd_gp <- gpWrapperHet(design_info$input, matrix(design_info$fwd, ncol=1), normalize_output=TRUE, scale_input=TRUE)
em_fwd_gp$fit("Gaussian", "constant", estimate_nugget=FALSE)
em_fwd <- llikEmulatorFwdGaussDiag("em_fwd", em_fwd_gp, y, sig2=inv_prob$sig2_true, 
                                   default_conditional=default_conditional, 
                                   default_normalize=default_normalize, use_fixed_lik_par=TRUE, 
                                   par_names=rownames(par_prior_params))
emulator_pred_fwd <- em_fwd$predict_emulator(test_info$input, return_cov=TRUE)
```


```{r}
# Plots 

em_llik$plot_pred_1d(test_info$input, include_interval=TRUE, true_llik=test_info$llik, 
                     CI_prob=CI_prob, plot_type="lik", emulator_pred_list=emulator_pred_llik, interval_method="pm_std_dev")
em_llik$plot_samp_1d(test_info$input, lik_par_val=inv_prob$sig2_true, N_samp=5, 
                     plot_type="lik", true_llik=test_info$llik, include_design=TRUE, 
                     emulator_pred_list=emulator_pred_llik)

# TODO: check `true_llik` in the plotting function. 
em_fwd$plot_pred_1d(test_info$input, emulator_pred_list=emulator_pred_fwd, 
                    plot_type="lik", include_interval=FALSE, true_llik=test_info$llik)
em_fwd$emulator_model$plot_pred_1d(test_info$input, CI_prob=CI_prob, Y_new=matrix(test_info$fwd, ncol=1), pred_list=emulator_pred_fwd)[[1]]
em_fwd$plot_samp_1d(test_info$input, N_samp=5, plot_type="lik", true_llik=test_info$llik, 
                    include_design=TRUE, emulator_pred_list=emulator_pred_fwd)


pred_marg <- em_fwd$calc_lik_approx(test_info$input, approx_type="marginal", emulator_pred_list=emulator_pred_fwd)
pred_mean <- em_fwd$calc_lik_approx(test_info$input, approx_type="mean", emulator_pred_list=emulator_pred_fwd)
plot(test_info$input, pred_marg, type="l", col="green")
lines(test_info$input, pred_mean)
lines(test_info$input, exp(test_info$llik), col="red")


plot_curves_1d_helper(test_info$input, cbind(marginal=pred_marg, mean=pred_mean), 
                      y_new=exp(test_info$llik), X_design=design_info$input, 
                      y_design=exp(design_info$llik), plot_title="Likelihood Approximations",
                      xlab="u", ylab="Likelihood")




```










