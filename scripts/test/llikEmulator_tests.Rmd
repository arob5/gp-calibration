---
title: "Tests for llikEmulator and Classes which Inherit from llikEmulator"
author: "Andrew Roberts"
date: '2024-02-13'
output: html_document
---

```{r, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(lhs)
library(ggplot2)
library(viridis)
library(parallel)
library(data.table)

base_dir <- getwd()
src_dir <- file.path(base_dir, "src")

source(file.path(src_dir, "gpWrapper.r"))
source(file.path(src_dir, "llikEmulator.r"))
source(file.path(src_dir, "sim_study_functions.r"))
source(file.path(src_dir, "mcmc_calibration_functions.r"))
```

```{r}
global_seed <- 22
data_seed <- 9

set.seed(global_seed)
```


```{r}
#
# Linear Gaussian Model to perform tests.  
#

N_obs <- 100
N_missing_output1 <- 4
N_missing_output2 <- 6

# 1D input, 2D output, some missing observations. 
G1_mat <- sin(2*pi*seq(1,N_obs)/N_obs)
G2_mat <- cos(2*pi*3*seq(1,N_obs)/N_obs)
G <- function(U) cbind(G1_mat %*% t(U), G2_mat %*% t(U))
u_true <- matrix(rnorm(1, 0, 3), nrow=1)
sig2_true <- c(1, 1.5)
G_true <- G(u_true)
Y <- G_true + cbind(rnorm(N_obs, 0, sqrt(sig2_true[1])), 
                    rnorm(N_obs, 0, sqrt(sig2_true[2])))
Y[sample.int(N_obs, N_missing_output1),1] <- NA_real_
Y[sample.int(N_obs, N_missing_output2),2] <- NA_real_

for(p in 1:ncol(Y)) {
  plot(1:N_obs, Y[,p], main=paste0("Ground Truth and Observed Data: Output ", p), 
       xlab="t", ylab="y")
  lines(1:N_obs, G_true[,p], col="red")
}

```


# 1d validation. 

TODO: need to also add check for negative predictive variance in covariance matrix. 

## hetGP
```{r}
# Fit
gpHet1 <- gpWrapperHet(X1, Y1, normalize_output=TRUE, scale_input=TRUE)
gpHet1$fit("Gaussian", "constant")
```

```{r}
# Predict 
gpHet1_pred <- gpHet1$predict(X1_new, return_cov=TRUE)
gpHet1$plot_pred_1d(X1_new, pred_list=gpHet1_pred, Y_new=Y1_new_noiseless)
```


```{r}
# Sample 
gpHet1_samp <- gpHet1$sample(X1_new, use_cov=TRUE, N_samp=5, pred_list=gpHet1_pred)
for(i in 1:gpHet1$Y_dim) {
  matplot(X1_new, gpHet1_samp[,,i],type="l")
  lines(X1_new, Y1_new_noiseless[,i], col="red")
}
```

# 2d validation. 

## hetGP
```{r}
# Fit
gpHet2 <- gpWrapperHet(X2, Y2, normalize_output=TRUE, scale_input=TRUE)
gpHet2$fit("Matern3_2", "constant", estimate_nugget=FALSE)
```

```{r}
# TODO: Add plot_pred_2d for 2d heatmap plots so I can validate this plot. 
# TODO: Add prediction intervals. 
# Predict and plot. 
# gpHet2_pred <- gpHet2$predict(X2_new)
gpHet2$plot_pred(X2_new, Y2_new)
```







